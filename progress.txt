# Ralph Progress Log
Started: 2026-01-31

## Codebase Patterns
- Use npm workspaces: frontend at `src/frontend`, backend at `src/backend`
- Run `npm run typecheck` from root to check both packages
- Backend uses tsx for development, Express with TypeScript
- Frontend uses Next.js 14 with App Router and Tailwind CSS

- Data types are defined in `src/backend/src/types/data.ts`
- Data loader module is at `src/backend/src/data/loader.ts`
- Data is loaded via `loadData()` function on server startup
- Access data through exported functions: `getProducts()`, `getMediaBuys()`, `getDeliveryMetrics()`, `getCreativeFormats()`, etc.
- Tools are implemented in `src/backend/src/tools/` with individual files per tool
- Export all tools from `src/backend/src/tools/index.ts`
- Creative formats are static reference data stored in the loader (not in JSON file)
- Authorized properties are also static reference data stored in the loader
- Access authorized properties through `getAuthorizedProperties()` and `getAuthorizedPropertyById()`
- WebSocket module is at `src/backend/src/websocket/socket.ts`
- Use `initializeWebSocket(httpServer)` to initialize Socket.io
- Use `getIO()` to get the Socket.io server instance
- Broadcast functions: `broadcastMediaBuyUpdated()`, `broadcastMediaBuyCreated()`, `broadcastFeedbackSubmitted()`
- WebSocket events: `initial_state`, `media_buy_updated`, `media_buy_created`, `feedback_submitted`

- REST API routes are in `src/backend/src/routes/tools.ts`
- POST `/api/tools/:toolName` calls the appropriate tool with request body as input
- GET `/api/tools` returns list of available tool names
- Tool name mapping uses snake_case (e.g., `get_products`, `create_media_buy`)

---

## 2026-01-31 - US-011
- What was implemented: REST API endpoints for tools to enable frontend integration
- Files changed:
  - Created `src/backend/src/routes/tools.ts` (Router with tool endpoint and handler mapping)
  - Modified `src/backend/src/index.ts` (Added toolsRouter at `/api/tools`)
- **Learnings for future iterations:**
  - POST `/api/tools/:toolName` endpoint routes to appropriate tool handler
  - Request body is passed directly as tool input
  - Returns 404 with available_tools list if tool not found
  - Returns 500 with error message if tool execution fails
  - Tool handlers cast to ToolHandler type for unified interface
  - GET `/api/tools` returns list of available tools
  - CORS already configured in main app for localhost:3000
---

## 2026-01-31 - US-010
- What was implemented: WebSocket broadcasting with Socket.io for real-time state synchronization
- Files changed:
  - Created `src/backend/src/websocket/socket.ts` (Socket.io module with event types and broadcast functions)
  - Modified `src/backend/src/index.ts` (Integrated Socket.io with Express using http.createServer)
  - Modified `src/backend/src/tools/updateMediaBuy.ts` (Added broadcastMediaBuyUpdated call)
  - Modified `src/backend/src/tools/createMediaBuy.ts` (Added broadcastMediaBuyCreated call)
  - Modified `src/backend/src/tools/providePerformanceFeedback.ts` (Added broadcastFeedbackSubmitted call)
  - Modified `src/backend/package.json` (Added socket.io dependency)
- **Learnings for future iterations:**
  - Socket.io requires wrapping Express app with http.createServer
  - CORS configured for localhost:3000 (frontend) with credentials: true
  - On client connect, initial_state event is emitted with getFullState() data
  - All broadcast functions include timestamp in payload
  - Tools now automatically broadcast state changes to all connected clients
  - Event payloads include full media_buy and delivery_metrics for UI updates
  - Supports multiple connected clients (for chat + dashboard windows)
---

## 2026-01-31 - US-009
- What was implemented: provide_performance_feedback tool for submitting conversion data, lead quality, and brand lift feedback
- Files changed:
  - Created `src/backend/src/tools/providePerformanceFeedback.ts` (Tool implementation with input/output types)
  - Modified `src/backend/src/tools/index.ts` (Added providePerformanceFeedback export)
- **Learnings for future iterations:**
  - Tool accepts media_buy_id, feedback_type ('conversion_data' | 'lead_quality' | 'brand_lift'), and data object (FeedbackData)
  - Generates unique feedback_id using format: `fb_{media_buy_id}_{type_prefix}_{timestamp}`
  - Validates media_buy exists before processing
  - Calculates impact string based on feedback_type and data values:
    - conversion_data: Calculates ROAS and provides budget recommendations
    - lead_quality: Analyzes qualification rate and pipeline value
    - brand_lift: Evaluates awareness, consideration, and purchase intent lift
  - Uses addPerformanceFeedback() from loader to persist to performance_feedback_log
  - Returns status: 'processed' for all feedback
---

## 2026-01-31 - US-008
- What was implemented: update_media_buy tool for modifying existing campaigns with optimization operations
- Files changed:
  - Created `src/backend/src/tools/updateMediaBuy.ts` (Tool implementation with input/output types)
  - Modified `src/backend/src/tools/index.ts` (Added updateMediaBuy export)
- **Learnings for future iterations:**
  - Tool accepts media_buy_id and updates object containing one or more operations
  - Supported operations: remove_geo, add_geo, adjust_bid, set_daily_cap, shift_budget
  - remove_geo/add_geo: modifies targeting_overlay.geo_country_any_of in packages
  - adjust_bid: modifies current_bids in DeliveryMetrics (e.g., mobile_cpm, desktop_cpm)
  - set_daily_cap: stores daily_cap in current_bids for simplicity
  - shift_budget: adjusts spend between devices or audience segments
  - Returns changes_applied array with operation, details, previous_value, new_value
  - estimated_impact includes budget_change, reach_change_percent, efficiency_improvement, description
  - Uses updateMediaBuy() and updateDeliveryMetrics() from loader to persist changes
---

## 2026-01-31 - US-007
- What was implemented: get_media_buy_delivery tool for retrieving delivery/performance metrics
- Files changed:
  - Created `src/backend/src/tools/getMediaBuyDelivery.ts` (Tool implementation with input/output types)
  - Modified `src/backend/src/tools/index.ts` (Added getMediaBuyDelivery export)
- **Learnings for future iterations:**
  - Tool accepts optional media_buy_id parameter
  - When media_buy_id provided: returns single DeliveryMetricsOutput or error if not found
  - When media_buy_id omitted: returns all metrics as array with count
  - Output excludes current_bids from DeliveryMetrics (not in acceptance criteria)
  - Uses union type GetMediaBuyDeliveryResult for single vs. all results
  - Leverages existing getDeliveryMetrics(id?) from loader which handles both cases
---

## 2026-01-31 - US-006
- What was implemented: create_media_buy tool for launching new campaigns
- Files changed:
  - Created `src/backend/src/tools/createMediaBuy.ts` (Tool implementation with input/output types)
  - Modified `src/backend/src/tools/index.ts` (Added createMediaBuy export)
- **Learnings for future iterations:**
  - Tool accepts brand_name, product_id, budget, targeting (TargetingOverlay), start_time, end_time
  - Generates unique media_buy_id using format: `mb_{sanitized_brand}_{number}`
  - Validates product exists and budget meets product's minimum_budget
  - Estimates impressions based on product's lowest CPM: `(budget / cpm) * 1000`
  - Creates initial DeliveryMetrics with zero values for new media buy
  - Uses addMediaBuy() and addDeliveryMetrics() from loader to persist to in-memory state
  - Returns status: 'submitted' for new campaigns
---

## 2026-01-31 - US-005
- What was implemented: list_authorized_properties tool for retrieving accessible publisher properties
- Files changed:
  - Modified `src/backend/src/types/data.ts` (Added AuthorizedProperty interface)
  - Modified `src/backend/src/data/loader.ts` (Added authorizedProperties static data and getAuthorizedProperties(), getAuthorizedPropertyById() functions)
  - Created `src/backend/src/tools/listAuthorizedProperties.ts` (Tool implementation with type definitions)
  - Modified `src/backend/src/tools/index.ts` (Added listAuthorizedProperties export)
- **Learnings for future iterations:**
  - Authorized properties are static reference data like creative formats (not in JSON file)
  - Tool takes no parameters - returns all authorized properties
  - 10 properties total: ESPN, CNN, Weather.com, TechCrunch, Sports Illustrated, Bleacher Report, Forbes, Automotive News, Spotify, NYT
  - Each property includes authorization_level (standard/premium/exclusive), available_formats, and optional fields like discount_percent, audience_profile, special_capabilities
---

## 2026-01-31 - US-004
- What was implemented: list_creative_formats tool for retrieving ad format specifications
- Files changed:
  - Modified `src/backend/src/types/data.ts` (Added CreativeFormat and CreativeFormatSpecs interfaces)
  - Modified `src/backend/src/data/loader.ts` (Added creativeFormats static data and getCreativeFormats(), getCreativeFormatById() functions)
  - Created `src/backend/src/tools/listCreativeFormats.ts` (Tool implementation with type definitions)
  - Modified `src/backend/src/tools/index.ts` (Added listCreativeFormats export)
- **Learnings for future iterations:**
  - Creative formats are static reference data, not in the JSON file - they're defined directly in the loader
  - Supports 4 format types: display, video, native, audio
  - Includes 13 formats total: 6 display, 4 video, 2 native, 1 audio
  - Specs vary by format type (display has dimensions/file_size, video has duration/skip_after, native has headline/description limits)
---

## 2026-01-31 - US-003
- What was implemented: get_products tool for discovering advertising inventory
- Files changed:
  - Created `src/backend/src/tools/getProducts.ts` (Tool implementation with type definitions)
  - Created `src/backend/src/tools/index.ts` (Tool exports)
- **Learnings for future iterations:**
  - Tools wrap the data loader functions and provide a clean interface
  - Tool result includes `success`, `count`, and `filters_applied` metadata
  - Tools transform internal data types to output types for API consumers
  - Use `.js` extension in imports for ESM compatibility (e.g., `from '../data/loader.js'`)
---

## 2026-01-31 - US-002
- What was implemented: Mock data layer loading from JSON
- Files changed:
  - Created `src/backend/src/types/data.ts` (TypeScript types for all data structures)
  - Created `src/backend/src/data/loader.ts` (Data loader with exported access functions)
  - Modified `src/backend/src/index.ts` (Load data on startup)
- **Learnings for future iterations:**
  - Data is loaded from `data/adcp_demo_complete_data.json` relative to backend's CWD
  - In-memory state allows mutations during demo via update functions
  - Available access functions: `getProducts()`, `getProductById()`, `getMediaBuys()`, `getMediaBuyById()`, `addMediaBuy()`, `updateMediaBuy()`, `getDeliveryMetrics()`, `updateDeliveryMetrics()`, `addDeliveryMetrics()`, `getAggregations()`, `updateAggregations()`, `getPerformanceFeedback()`, `getFeedbackByMediaBuyId()`, `addPerformanceFeedback()`, `getFullState()`, `resetData()`, `isDataLoaded()`
  - All functions return copies of data or directly modify the in-memory state
---

## 2026-01-31 - US-001
- What was implemented: Project setup with Next.js 14 and Express backend
- Files changed:
  - Created `package.json` (root workspace config)
  - Created `src/frontend/` (Next.js 14 with App Router, Tailwind, TypeScript)
  - Created `src/backend/` (Express with TypeScript)
  - Created `.gitignore`
- **Learnings for future iterations:**
  - Use `npm run dev` from root to start both servers concurrently
  - Frontend runs on port 3000, backend on port 3001
  - Both packages have individual `typecheck` scripts
  - Next.js creates a `src/` folder inside frontend for app router structure
---
